<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Products</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 1rem; background: #f8f9fa; }
    h1 { color: #333; text-align: center; }
    button { padding: 0.5rem 1rem; cursor: pointer; border: none; border-radius: 6px; font-size: 1rem; }
    .add-btn { background: #28a745; color: white; font-weight: bold; }
    .add-btn:hover { background: #218838; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
    th { background: #007bff; color: white; padding: 1rem; text-align: left; }
    td { padding: 0.8rem; border-bottom: 1px solid #ddd; }
    td input, td textarea { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; }
    td textarea { resize: vertical; min-height: 60px; }
    .actions button { margin: 0.2rem; padding: 0.4rem 0.8rem; font-size: 0.9rem; }
    .save-btn { background: #007bff; color: white; }
    .save-btn:hover { background: #0056b3; }
    .delete-btn { background: #dc3545; color: white; }
    .delete-btn:hover { background: #c82333; }
    .status { padding: 0.8rem; text-align: center; font-weight: bold; margin: 1rem 0; border-radius: 6px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

  <h1>Admin Dashboard - Products</h1>
  <button class="add-btn" id="add-product">+ Add New Product</button>
  <div id="status"></div>

  <table id="products-table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Short Description</th>
        <th>Price</th>
        <th>Tag</th>
        <th>Description</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="products-list"></tbody>
  </table>

  <script>
    const API_URL = 'https://products-api.sergej-kaldesic.workers.dev/';
    let products = [];

    const statusDiv = document.getElementById('status');
    const tbody = document.getElementById('products-list');

    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.className = `status ${isError ? 'error' : 'success'}`;
      setTimeout(() => statusDiv.textContent = '', 4000);
    }

    async function fetchProducts() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('Failed to fetch');
        products = await res.json();
        renderProducts();
        showStatus('Products loaded successfully! ✅');
      } catch (err) {
        console.error(err);
        showStatus('Failed to load products from KV ❌', true);
        tbody.innerHTML = '<tr><td colspan="6">Unable to load products.</td></tr>';
      }
    }

    function renderProducts() {
      if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#666;">No products yet. Click "Add New Product" to start!</td></tr>';
        return;
      }

      tbody.innerHTML = products.map((p, i) => `
        <tr>
          <td><input value="${p.title || ''}" data-field="title" data-index="${i}"></td>
          <td><input value="${p.shortDesc || ''}" data-field="shortDesc" data-index="${i}"></td>
          <td><input value="${p.price || ''}" data-field="price" data-index="${i}" style="width:80px;"></td>
          <td><input value="${p.tag || ''}" data-field="tag" data-index="${i}" style="width:100px;"></td>
          <td><textarea data-field="description" data-index="${i}">${p.description || ''}</textarea></td>
          <td class="actions">
            <button class="save-btn" data-index="${i}">Save</button>
            <button class="delete-btn" data-index="${i}">Delete</button>
          </td>
        </tr>
      `).join('');

      // Attach event listeners
      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.onclick = () => saveProduct(btn.dataset.index);
      });
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = () => deleteProduct(btn.dataset.index);
      });
    }

    async function saveProduct(index) {
      const row = document.querySelectorAll('tr')[parseInt(index) + 1]; // +1 for header
      const inputs = row.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        const field = input.dataset.field;
        const value = input.value.trim();
        if (field === 'price') products[index][field] = value;
        else products[index][field] = value;
      });

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(products)
        });
        if (res.ok) {
          showStatus(`Product "${products[index].title || 'Untitled'}" saved! ✅`);
        } else throw new Error();
      } catch (err) {
        showStatus('Failed to save ❌', true);
      }
    }

    function deleteProduct(index) {
      if (!confirm('Delete this product permanently?')) return;
      products.splice(index, 1);
      saveAll();
    }

    async function saveAll() {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(products)
        });
        if (res.ok) {
          renderProducts();
          showStatus('All changes saved! ✅');
        }
      } catch (err) {
        showStatus('Failed to save changes ❌', true);
      }
    }

    document.getElementById('add-product').onclick = () => {
      products.push({
        id: Date.now(),
        title: 'New Product',
        shortDesc: 'Short description',
        price: '0.00',
        tag: 'new',
        description: 'Full description here...',
        images: []
      });
      renderProducts();
      showStatus('New product added! Edit and click Save.');
    };

    // Load on start
    fetchProducts();
  </script>
</body>
</html>
